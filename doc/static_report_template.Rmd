---
title: "SynergyFinder Report"
author: "SynergyFinder (http://synergyfinder.org/)"
date: "`r Sys.Date()`"
output: pdf_document
params:
  data: NA
  blocks: NA
  correct_baseline: NA
  DRC_plots: NA
  DR_multi_high_value_color: NA
  DR_multi_low_value_color: NA
  DR_multi_point: NA
  DR_multi_point_color: NA
  DR_plot_type: NA
  DR_rep_statistic: NA
  DR_summary_statistic: NA
  DR_high_value_color: NA
  DR_low_value_color: NA
  DR_heatmap_label_color: NA
  DR_grid: NA
  syn_multi_high_value_color: NA
  syn_multi_low_value_color: NA
  syn_multi_point: NA
  syn_multi_point_color: NA
  syn_plot_type: NA
  syn_summary_statistic: NA
  syn_high_value_color: NA
  syn_low_value_color: NA
  syn_heatmap_label_color: NA
  syn_rep_statistic: NA
  syn_grid: NA
  bb_highlight_pos_color: NA
  bb_highlight_neg_color: NA
  bb_pos_value_color: NA
  bb_neg_value_color: NA
  ss_point_color: NA
  ss_point_size: NA
  ss_show_label: NA
  ss_label_color: NA
  ss_label_size: NA
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```
```{r include=FALSE}
library(tidyverse)
library(synergyfinder)
library(TidyComb)
synergyfinder_obj <- params$data
ndrug <- sum(grepl("drug", colnames(synergyfinder_obj$drug_pairs)))
methods = c("ZIP", "Loewe", "Bliss", "HSA")

if (is.null(params$DR_multi_high_value_color)) {
  DR_multi_high_value_color <- "#CC3311"
} else {
  DR_multi_high_value_color <- params$DR_multi_high_value_color
}
if (is.null(params$DR_multi_low_value_color)) {
  DR_multi_low_value_color <- "#448BD4"
} else {
  DR_multi_low_value_color <- params$DR_multi_low_value_color
}
if (is.null(params$DR_multi_point_color)) {
  DR_multi_point_color <- "#DDA137"
} else {
  DR_multi_point_color <- params$DR_multi_point_color
}
if (is.null(params$DR_multi_point)) {
  DR_multi_point <- TRUE
} else {
  DR_multi_point <- params$DR_multi_point
}
if (is.null(params$syn_multi_high_value_color)) {
  syn_multi_high_value_color <- "#CC3311"
} else {
  syn_multi_high_value_color <- params$syn_multi_high_value_color
}
if (is.null(params$syn_multi_low_value_color)) {
  syn_multi_low_value_color <- "#448BD4"
} else {
  syn_multi_low_value_color <- params$syn_multi_low_value_color
}
if (is.null(params$syn_multi_point_color)) {
  syn_multi_point_color <- "#DDA137"
} else {
  syn_multi_point_color <- params$syn_multi_point_color
}
if (is.null(params$syn_multi_point)) {
  syn_multi_point <- TRUE
} else {
  syn_multi_point <- params$syn_multi_point
}
```

# 1. Data tables

## 1. Meta data table

```{r meta_table}
table <- synergyfinder_obj$drug_pairs %>% 
  dplyr::filter(block_id == params$blocks) %>% 
  dplyr::select(
    block_id,
    dplyr::starts_with("drug"),
    dplyr::starts_with("conc_unit"),
    dplyr::starts_with("cell"))

knitr::kable(table)
  # kableExtra::kbl() %>%
  # kableExtra::kable_classic(full_width = F)
```

## 2. Synergy socores summary table

```{r synergy_table}
synergyfinder_obj$drug_pairs %>% 
  dplyr::filter(block_id == params$blocks) %>% 
  dplyr::select(
    block_id,
    dplyr::contains("synergy")) %>% 
  knitr::kable()
  # kableExtra::kbl() %>%
  # kableExtra::kable_classic(full_width = F)
```

## 3. Sensitivity socores summary table

```{r sensitive_table}
synergyfinder_obj$drug_pairs %>% 
  dplyr::filter(block_id == params$blocks) %>% 
  dplyr::select(
    block_id,
    dplyr::contains("ri"),
    dplyr::contains("css")) %>% 
  knitr::kable()
  # kableExtra::kbl() %>%
  # kableExtra::kable_classic(full_width = F)
```

## 4. Calcuclation setting

```{r calculate_setting}
cat("Correct Baseline: ", params$correct_baseline)
```

# 2. Dose response curve

```{r load_dose_response_curve, fig.show="hold", out.width="50%"}
knitr::include_graphics(params$DRC_plots)
```

# 3. Dose response map

```{r dose_response_map, fig.show="hold", out.width="50%"}
for (b in params$blocks) {
  # if (ndrug > 2) {
  #   p <- PlotMultiDrugSurface(
  #     data = synergyfinder_obj,
  #     plot_block = b,
  #     plot_value = "response",
  #     plot_title = paste0("Block ", b, " Dose Response Matrix"),
  #     high_value_color = DR_multi_high_value_color,
  #     low_value_color = DR_multi_low_value_color,
  #     show_data_points = DR_multi_point,
  #     point_color = DR_multi_point_color
  #   )
  #   print(p)
  # }
  comb <- combn(1:ndrug, 2)
  for (c in 1:ncol(comb)) {
    if (params$DR_plot_type == "heatmap") {
      p <- Plot2DrugHeatmap(
        data = synergyfinder_obj,
        plot_block = b,
        plot_title = paste0("Block ", b, " Dose Response Matrix"),
        drugs = c(comb[1, c], comb[2, c]),
        dynamic = FALSE,
        statistic = params$DR_rep_statistic,
        summary_statistic = params$DR_summary_statistic,
        high_value_color = params$DR_high_value_color,
        low_value_color = params$DR_low_value_color,
        # text_label_size_scale = params$DR_heatmap_label_size,
        text_label_color = params$DR_heatmap_label_color
        # title_text_size_scale = params$DR_text_size
      )
      print(p)
    } else {
      p <- Plot2DrugSurface(
        data = synergyfinder_obj,
        drugs = c(comb[1, c], comb[2, c]),
        plot_block = b,
        plot_title = paste0("Block ", b, " Dose Response Matrix"),
        dynamic = FALSE,
        summary_statistic = params$DR_summary_statistic,
        high_value_color = params$DR_high_value_color,
        low_value_color = params$DR_low_value_color,
        grid = params$DR_grid
        # text_size_scale = params$DR_text_size
      )
      print(p)
    }
  }
}
```

# 4. Synergy Scores

```{r, synergy_plots, fig.show="hold", out.width="50%"}
for (b in params$blocks) {
  # multi-drug dimension reduction surface
  # if (ndrug > 2) {
  #   for (m in methods) {
  #     p <- PlotMultiDrugSurface(
  #       data = synergyfinder_obj,
  #       plot_block = b,
  #       plot_title = paste("Block", b, m, "Synergy Score", sep = " "),
  #       plot_value = paste0(m, "_synergy"),
  #       dynamic = FALSE,
  #       high_value_color = syn_multi_high_value_color,
  #       low_value_color = syn_multi_low_value_color,
  #       show_data_points = syn_multi_point,
  #       point_color = syn_multi_point_color
  #     )
  #     print(p)
  #   }
  # }
  # 2-drug synergy surface
  for (c in 1:ncol(comb)) {
    for (m in methods) {
    p <- PlotSynergy(
      data = synergyfinder_obj,
      block_ids = b,
      plot_title = paste("Block", b, m, "Synergy Score", sep = " "),
      drugs = c(comb[1, c], comb[2, c]),
      type = params$syn_plot_type,
      method = m,
      dynamic = FALSE,
      summary_statistic = params$syn_summary_statistic,
      high_value_color = params$syn_high_value_color,
      low_value_color = params$syn_low_value_color,
      # text_size_scale = params$syn_text_size,
      heatmap_text_label_color = params$syn_heatmap_label_color,
      # heatmap_text_label_size_scale = params$syn_heatmap_label_size,
      statistic = params$syn_rep_statistic,
      surface_grid = params$syn_grid,
      display = FALSE
    )
    print(p[[1]])
    }
  }
}
```

# 5. Bar plots

```{r results='asis'}
  # multi-drug bar plot
for (b in params$blocks) {
  p <- PlotMultiDrugBar(
    data = synergyfinder_obj,
    plot_block = b,
    plot_value = c(
      "response", "ZIP_synergy", "HSA_synergy",
      "Bliss_synergy", "Loewe_synergy"
    ),
    highlight_row = NULL,
    sort_by = "response",
    panel_title_size = 6,
    axis_text_size = 5,
    highlight_label_size = 5,
    highlight_pos_color = params$bb_highlight_pos_color,
    highlight_neg_color = params$bb_highlight_neg_color,
    pos_value_color = params$bb_pos_value_color,
    neg_value_color = params$bb_neg_value_color,
    data_table = FALSE
  )
  print(p)
}
```

# 6. S-S plot

```{r ss_plot, fig.show="hold", out.width="50%"}
for (b in params$blocks) {
  # multi-drug dimension reduction surface
  for (m in methods) {
    p <- PlotSensitiveSynergy(
      data = synergyfinder_obj,
      plot_synergy = m,
      plot_title = paste("Block", b, m, "- CSS", sep = " "),
      point_color = params$ss_point_color,
      point_size = 3,
      show_labels = params$ss_show_label,
      point_label_color = params$ss_label_color,
      label_size = 10,
      dynamic = FALSE
    )
    print(p)
  }
}
```

# Reference

* For use of Synergyfinder web application:

Ianevski, A.; He, L.; Aittokallio, T.; Tang, J. SynergyFinder: A Web Application for Analyzing Drug Combination Dose-Response Matrix Data Bioinformatics 2017, 33 (15), 2413–2415. doi:10.1093/bioinformatics/btx162

* For use of SynergyFinder R pacakge:

He, L.; Kulesskiy, E.; Saarela, J.; Turunen, L.; Wennerberg, K.; Aittokallio, T.; Tang, J. Methods for High-Throughput Drug Combination Screening and Synergy Scoring. Methods Mol Biol 2018, 1711, 351–398. doi:10.1007/978-1-4939-7493-1_17

* For use of ZIP synergy scoring:

Yadav, B.; Wennerberg, K.; Aittokallio, T.; Tang, J. Searching for Drug Synergy in Complex Dose-Response Landscapes Using an Interaction Potency Model. Comput Struct Biotechnol J 2015, 13, 504–513. doi:10.1016/j.csbj.2015.09.001

* For how to harmonize the different synergy scoring methods:

Tang, J.; Wennerberg, K.; Aittokallio, T. What Is Synergy? The Saariselkä Agreement Revisited. Front Pharmacol 2015, 6, 181. doi:10.3389/fphar.2015.00181

* For general ideas of drug combination therapies:

Tang, J. Informatics Approaches for Predicting, Understanding, and Testing Cancer Drug Combinations. Methods Mol Biol 2017, 1636, 485–506. doi:10.1007/978-1-4939-7154-1_30

* For retrieving the most comprehensive drug combination data resources and their sensitivity and synergy results by SynergyFinder, please go to DrugComb :

Zagidullin, B.; Aldahdooh, J.; Zheng, S.; Wang, W.; Wang, Y.; Saad, J.; Malyutina, A.; Jafari, M.; Tanoli, Z.; Pessia, A.; Tang, J. DrugComb: An Integrative Cancer Drug Combination Data Portal. Nucleic Acids Res 2019, 47 (W1), W43–W51. doi:10.1093/nar/gkz337

* For use of combination sensitivity score:

Malyutina, A.; Majumder, M. M.; Wang, W.; Pessia, A.; Heckman, C. A.; Tang, J. Drug Combination Sensitivity Scoring Facilitates the Discovery of Synergistic and Efficacious Drug Combinations in Cancer. PLOS Computational Biology 2019, 15 (5), e1006752. 10.1371/journal.pcbi.1006752