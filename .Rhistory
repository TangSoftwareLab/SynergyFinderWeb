tmp <- rename(tmp, cell_line_id = "cell_line_name")
}
}, error = function(e){
print(e)
})
summary_table <- rbind.data.frame(summary_table, tmp)
}
min(summary_table$block_id)
max(summary_table$block_id)
max(summary_table$block_id) - min(summary_table$block_id) + 1 == nrow(summary_table)
nrow(summary_table)
sum(duplicated(summary_table$block_id))
max(c(summary_table$drug_row_id, summary_table$drug_col_id))
table(table(summary_table$block_id))
apply(summary_table, 2, function(x){sum(is.na(x))})
for (i in 1:nrow(drug_index)) {
summary_table$drug_row[which(summary_table$drug_row == drug_index$old_id[i])] <- drug_index$new_id[i]
summary_table$drug_col[which(summary_table$drug_col == drug_index$old_id[i])] <- drug_index$new_id[i]
}
summary_table <- summary_table %>%
left_join(block_index, by = c("block_id" = "old_id")) %>%
mutate(quality = rep(NA, n())) %>%
arrange(new_id, drug_row_id, drug_col_id) %>%
select(block_id = new_id, drug_row_id = drug_row, drug_col_id = drug_col,
cell_line_id, conc_r_unit, conc_c_unit, synergy_zip,
synergy_bliss, synergy_loewe, synergy_hsa, ic50_row, ic50_col, ri_row,
ri_col, css_row, css_col, S_sum, S_mean, S_max, quality, css_ri = css) %>%
unique()
min(summary_table$block_id)
max(summary_table$block_id)
max(c(summary_table$drug_row_id, summary_table$drug_col_id))
unique(summary_table$cell_line_id)
max(summary_table$block_id) - min(summary_table$block_id) + 1 == nrow(summary_table)
table(table(summary_table$block_id))
apply(summary_table, 2, function(x){sum(is.na(x))})
write.csv(summary_table, "../data/output/summary.csv", row.names = FALSE)
rm(list = ls())
block_index <- read.csv("../data/tmp/block_index.csv", stringsAsFactors = FALSE)
files <- grep("surface", list.files("../data/raw/final/", full.names = TRUE), value = TRUE)
surface_table <- NULL
for (f in files){
tmp <- read.csv(f, stringsAsFactors = FALSE, header = TRUE)
surface_table <- rbind.data.frame(surface_table, tmp)
}
min(surface_table$block_id)
max(surface_table$block_id)
max(surface_table$block_id) - min(surface_table$block_id) + 1 == length(unique(surface_table$block_id))
table(table(surface_table$block_id))
apply(surface_table, 2, function(x){sum(is.na(x))})
surface_table <- surface_table %>%
left_join(block_index, by = c("block_id" = "old_id")) %>%
select(conc_r, conc_c, inhibition, block_id = new_id, synergy_zip,
synergy_bliss, synergy_hsa, synergy_loewe) %>%
arrange(block_id, conc_r, conc_c) %>%
unique()
min(surface_table$block_id)
max(surface_table$block_id)
max(surface_table$block_id) - min(surface_table$block_id) + 1 == length(unique(surface_table$block_id))
table(table(surface_table$block_id))
apply(surface_table, 2, function(x){sum(is.na(x))})
write.csv(surface_table, "../data/output/surface.csv", row.names = FALSE)
rm(list = ls())
drug_index <- read.csv("../data/tmp/drug_id_change_table.csv", stringsAsFactors = FALSE)
block_index <- read.csv("../data/tmp/block_index.csv", stringsAsFactors = FALSE)
files <- grep("curve", list.files("../data/raw/final/", full.names = TRUE), value = TRUE)
curve_table <- NULL
for (f in files){
tmp <- read.csv(f, stringsAsFactors = FALSE, header = TRUE)
curve_table <- rbind.data.frame(curve_table, tmp)
}
min(curve_table$block_id)
max(curve_table$block_id)
max(curve_table$block_id) - min(curve_table$block_id) + 1 == nrow(curve_table) / 2
table(table(curve_table$block_id))
apply(curve_table, 2, function(x){sum(is.na(x))})
for (i in 1:nrow(drug_index)) {
curve_table$drug_row[which(curve_table$drug_row == drug_index$old_id[i])] <- drug_index$new_id[i]
curve_table$drug_col[which(curve_table$drug_col == drug_index$old_id[i])] <- drug_index$new_id[i]
}
curve_table <- curve_table %>%
left_join(block_index, by = c("block_id" = "old_id")) %>%
select(block_id = new_id, b, c, d, e, model, drug_row_id, drug_col_id) %>%
arrange(block_id, drug_row_id, drug_col_id) %>%
unique()
min(curve_table$block_id)
max(curve_table$block_id)
max(curve_table$block_id) - min(curve_table$block_id) + 1 == nrow(curve_table) / 2
table(table(curve_table$block_id))
apply(curve_table, 2, function(x){sum(is.na(x))})
write.csv(curve_table, "../data/output/curve.csv", row.names = FALSE)
rm(list = ls())
assay_table <- read.csv("../data/raw/assay_cell_name_cell_id.csv", stringsAsFactors = FALSE)
assay_table <- assay_table %>%
select(assay_id, assay_type, plate_format, cell_per_well, detection_technology,
negative_control, negative_control_conc, positive_control,
positive_control_conc_nm, time_h)
write.csv(assay_table, "../data/output/assay.csv", row.names = FALSE)
rm(list = ls())
summary_table <- read.csv("../data/output/summary.csv", stringsAsFactors = FALSE)
assay <- read.csv("../data/raw/assay_cell_name_cell_id.csv", stringsAsFactors = FALSE)
source_table <- summary_table %>%
left_join(assay, by = c("cell_line_id" = "cell_id")) %>%
mutate(study_id = rep(24, n())) %>%
arrange(block_id, study_id, assay_id) %>%
select(block_id, study_id, assay_id)
min(source_table$block_id)
max(source_table$block_id)
max(source_table$block_id) - min(source_table$block_id) + 1 == nrow(source_table)
unique(source_table$study_id)
unique(source_table$assay_id)
table(table(source_table$block_id))
table(table(source_table$assay_id))
table(table(source_table$study_id))
apply(source_table, 2, function(x){sum(is.na(x))})
write.csv(source_table, "../data/output/source.csv", row.names = FALSE)
sessionInfo()
block_index <- read.csv("../data/tmp/malaria1/block_index.csv", stringsAsFactors = FALSE)
files <- list.files("../data/raw/malaria1_NCATS/upload/calculate/output/surface/",
full.names = TRUE)
files <- c(files, "../data/raw/malaria1_NCATS/upload/calculate/surface_eq.csv")
surface_table <- NULL
for (f in files){
tmp <- read.csv(f, stringsAsFactors = FALSE, header = TRUE)
surface_table <- rbind.data.frame(surface_table, tmp)
}
min(surface_table$block_id)
max(surface_table$block_id)
max(surface_table$block_id) - min(surface_table$block_id) + 1 == length(unique(surface_table$block_id))
table(table(surface_table$block_id))
apply(surface_table, 2, function(x){sum(is.na(x))})
surface_table <- surface_table %>%
left_join(block_index, by = c("block_id" = "old_id")) %>%
select(conc_r, conc_c, inhibition, block_id = new_id, synergy_zip,
synergy_bliss, synergy_hsa, synergy_loewe) %>%
unique()
library(TidyComb)
library(tidyverse)
surface_table <- surface_table %>%
left_join(block_index, by = c("block_id" = "old_id")) %>%
select(conc_r, conc_c, inhibition, block_id = new_id, synergy_zip,
synergy_bliss, synergy_hsa, synergy_loewe) %>%
unique()
min(surface_table$block_id)
max(surface_table$block_id)
max(surface_table$block_id) - min(surface_table$block_id) + 1 == length(unique(surface_table$block_id))
table(table(surface_table$block_id))
apply(surface_table, 2, function(x){sum(is.na(x))})
for (b in seq(1456572, max(surface_table$block_id), by = 1000)){
tmp <- surface_table[which(surface_table$block_id %in% seq(b, b + 999)), ] %>%
arrange(block_id, conc_r, conc_c)
write.csv(tmp, paste0("../data/output/malaria1/surface_split/surface_",b , ".csv"), row.names = FALSE)
}
for (b in seq(1456572, max(surface_table$block_id), by = 1000)){
tmp <- read.csv(paste0("../data/output/malaria1/surface_split/surface_",b , ".csv"), stringsAsFactors = FALSE)
tmp <- select(tmp, block_id, conc_r, conc_c)
print(b)
print(sum(duplicated(tmp)))
}
rm(list = ls())
files <- c("../../2020.12.17_NTNU_HTS_by_Toulo/data/output/surface.csv",
"../../2020.12.09_merge_my_dataset_change_drug_id/data/output/surface.csv",
"../../2020.12.09_merge_data_from_Toulo/data/output/malaria1/surface.csv",
"../../2020.12.09_merge_data_from_Toulo/data/output/covid/surface.csv",
"../../2020.12.09_merge_data_from_Toulo/data/output/ebola/surface.csv",
"../../2020.12.09_merge_data_from_Toulo/data/output/fallahi/surface.csv"
)
surface_table <- NULL
for (f in files){
tmp <- read.csv(f, stringsAsFactors = FALSE, header = TRUE)
if (ncol(tmp) == 1){
tmp <- read.table(f, sep = ";", stringsAsFactors = FALSE, header = TRUE)
}
surface_table <- rbind.data.frame(surface_table, tmp)
}
surface_table <- arrange(surface_table, block_id, conc_r, conc_c)
min(surface_table$block_id)
max(surface_table$block_id)
max(surface_table$block_id) - min(surface_table$block_id) + 1 == length(unique(surface_table$block_id))
table(table(surface_table$block_id))
apply(surface_table, 2, function(x){sum(is.na(x))})
surface_table <- read.csv("../data/output/surface.csv", stringsAsFactors = FALSE)
surface_table <- filter(surface_table, block_id > 1468171)
write.csv(surface_table, "../data/output/surface_1468172.csv", row.names = FALSE)
surface_table <- select(block_id, conc_c, conc_r)
surface_table <- select(surface_table, block_id, conc_c, conc_r)
sum(duplicated(surface_table))
setwd("~/Documents/work/SynergyFinder_shiny_app/SynergyFinder")
shiny::runApp()
runApp()
# Module UI function
library(shinydashboard)
dashboardUI <- dashboardPage(#skin = "black",
# dash board header
dashboardHeader(disable = TRUE),
# sidebar content
dashboardSidebar(
# custom css for buttons and sliderinput
tags$head(
tags$link(rel = "stylesheet", type = "text/css", href = "allcss.css"),
tags$link(rel = "stylesheet", type = "text/css", href = "tooltip-curved.css"),
tags$link(rel = "stylesheet", type = "text/css", href = "drop.css"),
tags$script(src = "feedback_source.js"),
tags$script(src = "feedback.js"), #also to top button
tags$script(src = "tour.js")
),
# Menu elements
sidebarMenu(
id="menu1",
menuItem("Home", tabName = "tabHome"),
menuItem("Intro", tabName = "introTab"),
menuItem("User Guid", tabName = "userguidTab"),
menuItem("Upload Data", tabName = "inputdataTab"),
menuItem("Dose-response Map", tabName = "doseresponseTab"),
menuItem("Synergy Map", tabName = "synergyTab"),
menuItem("Download Report", tabName = "reportTab")
)
),
dashboardBody(class="DISABLED", id="body_d",
tags$style(".DISABLED { min-height: 100vh};"),
### changing theme
# shinyDashboardThemes(
#   theme = "grey_light"
# ),
# Custom theme ------------------------------------------------------------
uiChangeThemeOutput(),
# uiOutput(outputId='fillInput'),
# tags$head(tags$style(HTML('.alert-info,.bg-aqua,.callout.callout-info,.label-info,.modal-info .modal-body,
#                            .skin-blue .main-header .logo,.skin-blue .main-header .logo:hover,
#                            .skin-blue .main-header .navbar{background-image:linear-gradient(#54b4eb,#2fa4e7,#1d9ce5)}'))),
useToastr(),
shinyjs::useShinyjs(),
bsAlert("noPDdata"),
uiOutput(outputId='exData'),
uiOutput(outputId='errorTable'),
tabItems(
# Tab content -------------------------------------------------------------
tabItem(
tabName = "tabHome",
fluidRow(
column(
width = 12,
# Theme drop-down ---------------------------------------------------------
uiChangeThemeDropdown()
)
),
fluidRow(
column(
width = 6,
),
column(
width = 6,
# Theme drop-down ---------------------------------------------------------
uiChangeThemeDropdown()
)
)
),
tabItem(tabName = "introTab",
div(
br(),br(),br(),br(),br(),br(),br(),br(),br(),br(),br(),
fluidRow(column(offset = 3, width = 6,
div(
HTML('<div class="primary_header"><h1>SynergyFinder web application</h1><h2>an interactive tool for analyzing drug combination dose-response data </h2></div>'
),  br(),
HTML('<button type="button" id="buttonTour" class="btn btn-primary btn-lg">
<span class="glyphicon glyphicon-play"></span>
Start the tour
</button>'), id = "startour")
)), id = "wraptour")
),
tabItem(
tabName = "userguidTab",
div(
tags$p("How it works"),
br(),
# fluidRow(column(offset = 1, width = 10, HTML('<p align="center"><b>Video tutorial</b></p>'))),
# fluidRow(column(offset = 3, width = 6, HTML('<img onmouseover="" style="cursor: pointer;" onclick="javascript:openvideo()" src="vtt.png"></img>'))), hr(), br(),
# fluidRow(column(offset = 1, width = 10, HTML('<p align="center"><b>Technical documentation</b></p>'))),
# fluidRow(column(offset = 3, width = 6, HTML('<img onmouseover="" style="cursor: pointer;" onclick="javascript:techdoc()" src="manual.png"></img>'))),
# HTML('<object data="tech.pdf" type="application/pdf" width="100%" height="500"> alt : <a href="tech.pdf" download>tech.pdf</a></object>'),
HTML('<iframe src="https://player.vimeo.com/video/192242384" width="870" height="600" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>')
)
),
tabItem(
tabName = "inputdataTab",
# tags$h1("Upload Your Dataset"),
fluidPage(
fluidRow(
column(
width = 4,
tags$p("1. SynergyFinder accept three different file formats: CSV, XLSX, or TXT."),
div(id="annotfileid", uiOutput('resettableInput'),
HTML('<div id = "spanpop" class="tooltip-item"></div>')),
bsAlert("alertannotfile"),
),
column(
width = 4,
# HTML('
# <div id="tourfileformat" class="t-toggle-button">
#   <label class="t-toggle-button__option js-checked">
#     <input name="audience" value="designList" type="radio" checked="checked" id="paneltype_designer">
#     <span>Table</span>
#   </label>
#   <label class="t-toggle-button__option">
#     <input name="audience" value="devList" type="radio" id="panel-type_developer">
#     <span>Matrix</span>
#   </label>
# </div>
#      ')
tags$p("2. The drug combination data must be arrange in one of 2 formats: Table or Matrix."),
selectInput("inputDatatype", label = "Choose data format:", width = '100%',
choices = list("Table" = "Table", "Matrix" = "Matrix"),
selected = "Table")
),
column(
width = 4,
tags$p("3. The measurement for drug response be: inhibition or viability"),
selectInput("selectInhVia", label = "Choose readout:", width = '100%',
choices = list("","Inhibition" = "inhibition", "Viability" = "viability"),
selected = "")
),
),
fluidRow(
column(
width = 4,
tags$div(title="Move slider to visualize the drug combination dose-response data",
id = "toursliderdr",
switchButton(inputId = "Switch",
label = "Visualize dose-response data"))
),
column(
width = 4,
),
column(
width = 4,
tags$p("For more detail about input data, please check User Guid page.",
"Click the button below to download example files for testing purposes."),
downloadButton(outputId = "loadExData_small", label = "example data"))
),
hr()
)
), # tabItem - "inputTab"
tabItem(tabName = "doseresponseTab",
selectInput("correction", "Correction",
choices = list("Non" = "non", "Part" = "part", "All" = "all")),
hr(),
#when slider for PlotDoseresponse is on
conditionalPanel(
condition = "input.Switch == 1",
# dynamically create tabs with content
fluidRow(
box(width = 12, collapsible = F, id = "boxDose", solidHeader = !0,
column(10,
uiOutput(outputId='tabs')
),
column(2, br(),
box(width = 12.5, status = "info", collapsible = !0,
fluidRow(
column(10, offset = 1,
sliderInput(inputId = "height", label = "Height", min = 0, max = 1000, value = 500, step = 1))),
fluidRow(
column(10, offset = 1,
sliderInput(inputId = "width", label = "Width", min = 1, max = 13, value = 12, step = 1)))
),
box(id = "removeoutliers", width = 12.5, title = "Estimate missing responses or outliers", status = "info", collapsible = !0,
box(width = 12.5, title = "Choose concentration:",
fluidRow(column(12, uiOutput(outputId='increase1'))),
fluidRow(column(12, uiOutput(outputId='increase2'))),
fluidRow(column(10, offset = 2, actionButton("excludeconc", "Approx. conc.")))
)
)
)
)
)
),
tags$div(title="Calculate the synergy scores for drug combinations.", id = "tourcalcsyn",
switchButton(inputId = "Switch2",
label = "Calculate synergy")),
),
tabItem(tabName = "synergyTab",
# when slider for calcuate synergy is on
conditionalPanel(
condition = "input.Switch2 == 1",
div(selectInput("methods", "Method", choices = list("ZIP" = "ZIP", "Bliss" = "Bliss", "Loewe" = "Loewe", "HSA" = "HSA"), width = '40%'), id = "tourmodels"),
tags$div(title="Visualize the synergy scores for drug combinations as 2D or 3D interaction landscape over the dose-response matrix.", id = "tourvizsyn",
switchButton(inputId = "Switch4",
label = "Visualize synergy scores"))
),
hr(),
# when slider for plot synergy is on
conditionalPanel(
condition = "input.Switch4 == 1",
fluidRow(
box(width = 12, collapsible = F, id = "boxDose", solidHeader = !0, class = "heysyn",
fluidRow(uiOutput(outputId='tabs2')),
fluidRow( br(),
box(
width = 12, status = "info", solidHeader = !0, collapsible = !0, height = 770,
title = "Synergy Maps",
column(6,
tags$div(title="Brush and double-click to zoom",
plotOutput("plotsyn1", height = 600, dblclick = "plot7_dblclick", brush = brushOpts(id = "plotincrease_brush7",resetOnNew = !0))),
fluidRow(
column(4, downloadButton("download2Dsyn", label = "Download")),
tags$div(title="Show most synergistic area. \n on \n off",
column(4,
radioButtons("synarea", label = h4("Most synergistic area:"),
choices = list("ON" = 1, "OFF" = 0),
selected = 1, inline = !0)
)),
tags$div(title="Adjust 2D surface grid. \n grid on \n grid off",
column(4,
radioButtons("sizegridsyn", label = h4("Grid:"),
choices = list("ON" = 1, "OFF" = 0),
selected = 1, inline = !0)
)))
),
column(6,
fluidRow(
plotlyOutput("plotsyn2", height = 600)),
fluidRow(
column(4, downloadButton("download3Dsyn", label = "Download")),
tags$div(title="Adjust 3D surface grid. \n grid on \n grid off \n transparent grid",
column(5,offset = 3,
radioButtons("sizegridsyn2", label = h4("Grid:"),
choices = list("ON" = 1, "OFF" = 0, "transparent" = -1),
selected = 1, inline = !0)
)))
)
)
)
)
)
)
),
tabItem(tabName = "reportTab",
# tags$head(tags$style(HTML(".small-box {height: 105px}"))),
# valueBox(actionButton("Save_report", "Save!"), "Save full report", icon = icon("save", lib = "glyphicon"), width = 13),
# Save report
box(width = 12, collapsible = T,collapsed = T, id = "boxSave", solidHeader = !0, status = "info", title = "Static (pdf) report",
h6("In case of visualisation proplems use Adobe Reader"),
fluidRow(
column(width = 4,
selectInput("selectStatic2", "Dose response plot type", choices = list("all" = "all", "heatmap" = "heatmap", "curve" = "curve"), width = '97%')
),
column(width = 4,
selectInput("selectStatic", "Synergy plot type", choices = list("none" = "none", "all" = "all", "3D" = "3D", "2D" = "2D"), width = '97%')
),
column(3, offset = 1,
radioButtons("synareaRepStat", label = h4("Most synergistic area:"), choices = list("ON" = 1, "OFF" = 0),
selected = 1, inline = !0)
)
),
fluidRow(
column(12,
uiOutput(outputId='selectinputconprints')
)
),
downloadButton("downloadData2", label = "Download")
),
box(width = 12, collapsible = T, collapsed = T, id = "boxSave2", solidHeader = !0, status = "info", title = "Dynamic (pdf) report",
h6("In case of visualisation proplems use Adobe Reader"),
fluidRow(
column(width = 4,
selectInput("selectDynamic2", "Dose response plot type", choices = list("all" = "all", "heatmap" = "heatmap", "curve" = "curve"), width = '97%')
),
column(width = 4,
selectInput("selectDynamic", "Synergy plot type", choices = list("all" = "all", "3D" = "3D"), width = '97%')
),
column(3, offset = 1,
radioButtons("synareaRepDyn", label = h4("Most synergistic area:"), choices = list("ON" = 1, "OFF" = 0),
selected = 1, inline = !0)
)
),
fluidRow(
column(12,
uiOutput(outputId='selectinputconprintd')
)
),
downloadButton("downloadData", label = "Download")
),
box(width = 12, collapsible = T, collapsed = T, id = "boxSave3", solidHeader = !0, status = "info",
title = "Short (pdf) report (HeatMap + 2D Synergy plot)",
h6("In case of visualisation proplems use Adobe Reader"),
fluidRow(
column(12, uiOutput(outputId='selectinputconprintcomb'))),
fluidRow(
column(4,downloadButton("downloadData3", label = "Download")),
column(4, offset = 4,
radioButtons("synareaRep", label = h4("Most synergistic area:"), choices = list("ON" = 1, "OFF" = 0),
selected = 1, inline = !0)
)
)
),
box(width = 12, collapsible = T, collapsed = F, id = "boxSave4", title = "Synergy scores:",
fluidRow(column(12, offset = 0,
downloadButton("downloadSynscores1", label = "Download synergy scores(.xlsx)"),
downloadButton("downloadSynscores2", label = "Download synergy scores(.csv)"),
downloadButton("downloadSynscores3", label = "Download synergy scores(.txt)")#,
# HTML(paste0('<a download href="./synergy_scores.xlsx"><img src="xls.png" class = "marleft" alt="Smiley face" height="42" width="42"></a>
#              <a download href="./synergy_scores.csv"><img src="csv.png" class = "marleft" alt="Smiley face" height="42" width="42"></a>
#              <a download href="./synergy_scores.txt"><img src="txt.png" class = "marleft" alt="Smiley face" height="42" width="42"></a>'))
)))
)
),
HTML('<img src="werecommend.png" class="browsers_" alt="HTML5 Icon" width="124" height="65">')
#HTML('<footer style = "position:absolute!important;width:100%!important;bottom:0!important;left:50%!important">&copy; <script>document.write((new Date).getFullYear());</script>, FIMM</footer>')
)
)
runApp()
.rs.restartR()
runApp()
runApp()
